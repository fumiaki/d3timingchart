<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>STUDY01</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="timingChart.css">
    <script src="/lib/d3/d3.min.js"></script>
    <script src="ChartModel.js"></script>

  </head>
  <body>

    <svg id="chart" width="100%" height="100%" style="position: absolute; left: 0px; top: 0px">
      <g transform="translate(0, 0)">

        <g id="backPane" class="background">
          <rect class="chart" width="480" height="400" x="160" y="80"/>
          <rect class="x axis" width="480" height="80" x="160"/>
          <rect class="y axis" width="160" height="400" y="80"/>
        </g>

        <g id="xAxis" class="x axis" transform="translate(160,0)">
        </g>

        <g id="yAxis" class="y axis" transform="translate(0,80)">
        </g>

        <g id="plotPane" class="chart" transform="translate(160, 80)">
          <path d="M0,100 L100,100 L150,50 L250,50 L300,100"></path>
          <path id="e01" d="M100,200 L150,150"></path>
          <path id="e02" d="M250,250 L300,300"></path>
        </g>
      </g>
    </svg>

    <div  style="position: absolute; left: 0px; top: 0px">
      <h2>Timing Chart</h2>
      <p id="console1"></p>
      <p id="console2"></p>
      <p id="console3"></p>
    </div>

    <script>
    var sampleData = {
      nodes: [
        {
          //id:"e01",
          name:"Event 1",
          from: 0, to: 1, duration:50,
          y: 100, x: 100
        },
        {
          id:"e02",
          name:"Event 2",
          from: 0, to: 2, duration:50,
          y: 200, x: 150
        },
        {
          id:"e03",
          name:"Event 3",
          from: 1, to: 0, duration:100,
          y: 300, x: 250
        },
        {
          id:"e04",
          name:"Event 4",
          from: 0, to: 1, duration:25,
          y: 200, x: 350
        },
        {
          name:"Event 5"
        },
        {
          id:"e06",
          name:"Event 6",
          from: 0, to: 1, duration:0,
          y: 400, x: 200
        }
      ],
      links: [
        {
          name: "Link 1",
          from: "e02",
          to: "e03"
        },
        {
          name: "Link 2",
          from: "e06",
          to: "e04"
        }
      ]
    };

    var chart = ChartFactory.createChart();
    var sampleNodes = chart.createNodes(sampleData.nodes);
    var sampleLinks = chart.createLinks(sampleData.links);
    console.log(chart);

    // Main
    d3.select("#plotPane").selectAll(".event")
      .data(sampleNodes)
      .enter()
      .call(createEventNode);

    d3.select("#plotPane").selectAll(".link")
      .data(sampleLinks)
      .enter()
      .call(createLinkNode);


    function createEventNode(selection) {
      selection
        .append("g")
        .classed("event", true)
        .on("mouseover", function(d) {
          d3.select(this).classed("hover", true)
        })
        .on("mouseout", function(d) {
          d3.select(this).classed("hover", false)
        })
        .call(createEventVisual)
        .call(updateEventNode);
    };

    function createEventVisual(s) {
      s.append("rect")
        .classed("bodyHandle", true)
        .call(d3.drag()
          .on("start", function(d) {
            d3.select(this).classed("dragged", true);
          })
          .on("drag", function(d) {
            d.x += d3.event.dx;
            d3.select(this.parentNode).call(updateEventNode)
            d3.select("#console1").text(JSON.stringify(d));
            //d3.select("#console2").text(JSON.stringify(d3.event));
            d3.select("#console3").text(d3.mouse(this));
          })
          .on("end", function(d) {
            d3.select(this).classed("dragged", false);
          })
        );
      s.append("rect")
        .classed("resizeHandle", true)
        .call(d3.drag()
          .on("start", function(d) {
            d3.select(this).classed("dragged", true);
          })
          .on("drag", function(d) {
            d.duration = Math.max(d.duration + d3.event.dx, 0);
            d3.select(this.parentNode).call(updateEventNode)
            d3.select("#console1").text(JSON.stringify(d));
            //d3.select("#console2").text(JSON.stringify(d3.event));
            d3.select("#console3").text(d3.mouse(this));
          })
          .on("end", function(d) {
            d3.select(this).classed("dragged", false);
          })
        );
;
      s.append("path").classed("vis", true);
    };

    function updateEventNode(s) {
      s.select("rect.bodyHandle")
        .attr("x", function(d){return d.x - 4})
        .attr("y", function(d){return d.y - 4})
        .attr("width", function(d){return d.duration + 8})
        .attr("height", function(d){return Math.abs(d.to - d.from)*50 + 8});
        s.select("rect.resizeHandle")
          .attr("x", function(d){return d.x + d.duration + 4})
          .attr("y", function(d){return d.y - 4})
          .attr("width", function(d){return 16})
          .attr("height", function(d){return Math.abs(d.to - d.from)*50 + 8});
      s.select("path")
        .attr("d", function(d){
          var pathString
            = "M" + d.x + "," + (d.y + d.from*50)
            + " l" + d.duration + "," + ((d.to - d.from)*50);
          return pathString;
        })
    };

    </script>

  </body>
</html>
